<html layout:decorate="~{usr/layout/layout.html}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title></title>

    <script>
        function commentForm__submit(form) {
            form.content.value = form.content.value.trim(); // 댓글 좌우 공백 제거
            if (form.content.value.length === 0) {
                toastWarning('댓글의 내용을 입력해주세요.');
                form.content.focus();
                return;
            }

            if (form.content.value.length > 600) {
                toastWarning('댓글의 내용은 600자 이하로 입력해주세요.');
                form.content.focus();
                return;
            }

            form.submit();
        }

        function replyForm__submit(form) {
            form.content.value = form.content.value.trim(); // 답글 좌우 공백 제거
            if (form.content.value.length === 0) {
                toastWarning('답글의 내용을 입력해주세요.');
                form.content.focus();
                return;
            }

            if (form.content.value.length > 400) {
                toastWarning('답글의 내용은 400자 이하로 입력해주세요.');
                form.content.focus();
                return;
            }

            form.submit();
        }
    </script>
</head>

<body>

<main layout:fragment="main">
    <div class="flex flex-col align-center mx-auto w-4/6 my-3">
        <div class="flex justify-between">
            <span class="text-3xl font-bold" th:text="${freedomPost.title}"></span>
            <div class="flex">
                <span><i class="fa-solid fa-heart"></i>&nbsp;:&nbsp;</span>
                <span id="likeCnt" class="mr-2"></span>
                <span><i class="fa-solid fa-eye"></i>&nbsp;:&nbsp;</span>
                <span id="viewCnt"></span>
            </div>
        </div>
        <span class="badge badge-lg rounded-pill bg-neutral my-2 p-2"
              th:text="${freedomPost.categoryDisplayName()}"></span>
        <div class="w-full max-w-ls" style="min-height: 10vh" th:text="${freedomPost.content}"></div>
        <div class="flex justify-end">
            <button id="likeBtn" class="btn btn-sm btn-neutral mx-1">
                <i class="fa-solid fa-heart"></i>&nbsp;Like
            </button>
            <button class="btn btn-sm btn-neutral"
                    th:onclick="|location.href='@{/community/freedomPost/modify/} + ${freedomPost.id}'|"
                    th:if="${freedomPost.author != null and #authentication.getPrincipal().getUsername() == freedomPost.author.username}">
                <i class="fa-solid fa-eraser"></i>&nbsp;Modify
            </button>
            <button class="btn btn-sm btn-neutral mx-1"
                    th:if="${freedomPost.author != null and #authentication.getPrincipal().getUsername() == freedomPost.author.username}"
                    onclick="if(confirm('정말로 삭제하시겠습니까?')) $(this).next().submit();">
                <i class="fa-regular fa-trash-can"></i>&nbsp;Delete
            </button>
            <form hidden th:action="@{|/community/freedomPost/${freedomPost.id}|}" method="POST">
                <input type="hidden" name="_method" value="delete">
            </form>
        </div>

        <span class="text-xl font-bold my-2">댓글 쓰기</span>
        <!-- 댓글 작성 -->
        <form th:action="@{|/comment/create/${freedomPost.id}|}" th:object="${commentForm}" method="post" onsubmit="commentForm__submit(this); return false;">
            <textarea class="textarea textarea-bordered w-full max-w-ls form-control" placeholder="content"
                      th:field="*{content}" rows="4"></textarea>
            <input type="hidden" name="commentPage" th:value="${commentPaging.number}">
            <input type="submit" class="btn btn-sm btn-neutral my-2" value="댓글 등록">
        </form>

        <!-- 댓글의 갯수 표시 -->
        <div class="flex items-center">
            <i class="fa-solid fa-comments"></i>&nbsp;
            <span th:text="|${#lists.size(freedomPost.commentList)} comments|"></span>
        </div>
        <!-- 댓글 반복 시작 -->
        <div class="card w-full bg-base-100 shadow-xl my-2" th:each="comment : ${commentPaging}">
            <div class="card-body">
                <p th:text="${comment.content}"></p>
                <div class="card-actions justify-end">
                    <a href="javascript:void(0);" class="comment-answer btn btn-sm btn-outline-secondary"
                       th:data-num="${comment.id}">
                        reply&nbsp;
                        <span class="badge badge-sm rounded-pill bg-secondary"
                              th:text="${#lists.size(comment.replyList)}"></span>
                    </a>

                    <a class="btn btn-sm btn-outline-secondary"
                       href="javascript:void(0);"
                       th:if="${comment.author != null and #authentication.getPrincipal().getUsername() == comment.author.username}"
                       onclick="if ( confirm('정말로 삭제하시겠습니까?') ) $(this).next().submit();">
                        <i class="fa-regular fa-trash-can"></i></a>
                    <form hidden th:action="@{|/comment/${comment.id}|}" method="POST">
                        <input type="hidden" name="_method" value="delete">
                    </form>
                </div>
                <!-- 답글 등록 창-->
                <div class="comment-answer-block" style="display: none" th:id="${comment.id}"
                     th:classappend="|cm_${comment.getId()}|">
                    <a th:id="|comment-${comment.id}|"></a>
                    <div class="form-floating comment_box" style="text-align: end">
                        <form th:action="@{|/reply/create/${comment.id}|}" th:object="${commentForm}" method="post" onsubmit="replyForm__submit(this); return false;"
                              class="my-3">
                            <textarea class="textarea textarea-bordered w-full max-w-ls form-control" placeholder="content"
                                      th:field="*{content}" rows="2"></textarea>
                            <input type="hidden" name="commentPage" th:value="${commentPaging.number}">
                            <input type="submit" class="btn btn-sm btn-neutral my-2" value="답글 등록">
                        </form>
                    </div>

                    <!-- 댓글 창-->
                    <div class="list-group">
                        <div th:each="i: ${#numbers.sequence(comment.getReplyList().size()-1, 0, -1)}" class="comment-item list-group-item" th:with="reply=${comment.getReplyList().get(i)}">
                            <div>
                                <div class="flex">
                                    <div>⎿</div>
                                    <div class="p-2" style="word-break: break-word; overflow-wrap: break-word; white-space: normal;" th:text="${reply.content}"></div>
                                </div>

                                <div class="flex justify-end">
                                    <a class="btn btn-sm btn-outline-secondary" href="javascript:void(0);"
                                       th:if="${reply.author != null and #authentication.getPrincipal().getUsername() == reply.author.username}"
                                       onclick="if ( confirm('정말로 삭제하시겠습니까?') ) $(this).next().submit();">
                                        <i class="fa-regular fa-trash-can"></i></a>
                                    </a>
                                    <form hidden th:action="@{|/reply/${reply.id}|}" method="POST">
                                        <input type="hidden" name="_method" value="delete">
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 페이징처리 시작 -->
        <div th:if="${!commentPaging.isEmpty()}" class="flex justify-center mt-2">
            <div class="btn-group pagination">
                <a class="page-link btn btn-sm btn-outline btn-primary" th:disabled="${!commentPaging.hasPrevious} ? 'disabled'"
                   href="javascript:void(0)" th:data-page="${(commentPaging.number)-1}">
                    <span>이전</span>
                </a>
                <a th:text="${page}" class="page-link btn btn-sm btn-outline btn-primary"
                   th:each="page: ${#numbers.sequence(0, (commentPaging.totalPages)-1)}"
                   th:if="${page >= (commentPaging.number)-5 and page <= commentPaging.number+5}"
                   href="javascript:void(0)"
                   th:data-page="${page}"></a>
                <a class="page-link btn btn-sm btn-outline btn-primary" th:disabled="${!commentPaging.hasNext} ? 'disabled'"
                   href="javascript:void(0)" th:data-page="${commentPaging.number+1}">
                    <span>다음</span>
                </a>
            </div>
        </div>
        <!-- 페이징처리 끝 -->
        <!-- 댓글 페이징처리 끝 -->
        <form th:action="@{|/community/freedomPost/detail/${freedomPost.id}#comment-start|}" method="get" id="commentForm">
            <input type="hidden" id="commentPage" name="commentPage" th:value="${commentPaging.number}">
        </form>
    </div>

    <script th:inline="javascript">
        const page_elements = document.getElementsByClassName("page-link");
        Array.from(page_elements).forEach(function (element) {
            element.addEventListener('click', function () {
                document.getElementById('commentPage').value = this.dataset.page;
                document.getElementById('commentForm').submit();
            });
        });

        const comment_answer_elements = document.getElementsByClassName("comment-answer");
        const block_answer = document.getElementsByClassName("comment-answer-block");
        Array.from(comment_answer_elements).forEach(function (element) {
            element.addEventListener('click', function () {
                Array.from(block_answer).forEach((x) => {
                    if (x.id === this.dataset.num) {
                        if (x.style.display === "none") {
                            x.style.display = "block";
                        } else
                            x.style.display = "none";
                    }
                })
            });
        });

        if (window.location.hash && window.location.hash.indexOf("#reply-") !== -1) {
            const commentId = window.location.hash.replace("#reply-", "");
            $(function(){
                document.getElementsByClassName("cm_" + commentId)[0].style.display = "block";
            });
        }

        function likeBtnClick() {
            const header = $("meta[name='_csrf_header']").attr("content");
            const token = $("meta[name='_csrf']").attr("content");
            $(document).ajaxSend(function (e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });
            const postId = /*[[${freedomPost.id}]]*/ null;
            if (postId) {

                const likeButton = $('#likeBtn');
                $.ajax({
                    type: "POST",
                    url: "/pushLike", // 좋아요 요청을 보낼 URL
                    data: {
                        postId: postId
                    },
                    dataType: "json",
                    success: function (response) {
                        console.log(response)
                        console.log(response.result)
                        console.log(response.likeCnt)
                        if (response.result === "liked") { // 좋아요 데이터가 없음 -> 좋아요 표시
                            console.log("좋아요")
                            const newHtml = '<i class="fa-solid fa-heart"></i>&nbsp;Like'
                            likeButton.html(newHtml)

                        } else if (response.result === "unliked") {  // 좋아요 데이터가 있음 -> 좋아요 표시X
                            console.log("좋아요 취소")
                            const newHtml = '<i class="fa-regular fa-heart"></i>&nbsp;UnLike'
                            likeButton.html(newHtml)
                        }
                        console.log("pass")
                        $('#likeCnt').text(response.likeCnt)
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }
        }

        $(document).ready(function () {
            console.log('jQuery is loaded!');
            const header = $("meta[name='_csrf_header']").attr("content");
            const token = $("meta[name='_csrf']").attr("content");
            $(document).ajaxSend(function (e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });
            // 페이지가 로드될 때 실행되는 코드
            // Ajax 를 사용하여 데이터를 가져오는 등의 작업을 수행

            const postId = /*[[${freedomPost.id}]]*/ null;
            if (postId) {
                const likeButton = $('#likeBtn');
                $.ajax({
                    type: "GET",
                    url: "/findThumbsUpInfo", // 좋아요 요청을 보낼 URL
                    data: {
                        postId: postId
                    },
                    dataType: "json",
                    success: function (response) {
                        console.log(response)
                        if (response.result === "liked") {
                            // 좋아요 데이터가 없음 -> 좋아요 표시
                            const newHtml = '<i class="fa-solid fa-heart"></i>&nbsp;Like'
                            likeButton.html(newHtml)
                        } else if (response.result === "unliked") {
                            // 좋아요 데이터가 있음 -> 좋아요 표시X
                            const newHtml = '<i class="fa-solid fa-heart"></i>&nbsp;UnLike'
                            likeButton.html(newHtml)
                        }
                        $('#likeCnt').text(response.likeCnt)
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });

                const viewText = $('#viewCnt');
                $.ajax({
                    type: "GET",
                    url: "/community/freedomPost/getView", // 조회수 요청을 보낼 URL
                    data: {
                        postId: postId
                    },
                    dataType: "text",
                    success: function (data) {
                        console.log(data)
                        $(viewText).text(data)
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }

            // 버튼 클릭 이벤트 핸들러 등록
            $(document).on('click', '#likeBtn', function () {
                console.log("click")
                likeBtnClick();
            });
        });
    </script>
</main>
</body>

</html>