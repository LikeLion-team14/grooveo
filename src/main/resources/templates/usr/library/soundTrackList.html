<html layout:decorate="~{usr/layout/layout.html}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- 라이브러리 CSS 불러오기 -->
    <link rel="stylesheet" href="/resource/library/library.css">

    <title>라이브러리</title>
    <meta th:if="${error}" name="errorMsg" th:content="${exception}"/>
</head>

<body>
<main layout:fragment="main">
    <div class="flex flex-col align-center mx-auto max-w-7xl w-full mt-3 mb-28">
        <form th:action method="POST" class="flex flex-col gap-6" enctype="multipart/form-data">
            <div class="flex justify-center">
                <div class="posts-box">
                    <!-- 라이브러리 제목 -->
                    <div class="text-3xl font-bold mt-8 text-center">
                        LIBRARY
                    </div>

                    <!-- 카테고리 -->
                    <div class="flex justify-center mt-5">
                        <input type="radio" name="songlist" id="top" class="peer hidden" checked />
                        <label for="top" class="cursor-pointer mr-16 mt-2 text-base text-gray-500 hover:text-gray-800 hover:underline">
                            TOP100
                        </label>
                        <input type="radio" name="songlist" id="latest" class="peer hidden" />
                        <label for="latest" class="cursor-pointer mt-2 text-base text-gray-500 hover:text-gray-800 hover:underline">
                            최신 음악
                        </label>
                    </div>

                    <!-- 검색 박스 및 음악 등록 버튼 -->
                    <div class="search-box flex justify-end items-center mt-10">
                        <div class="relative">
                            <input type="text" placeholder="노래 / 아티스트 검색" id="search_kw"
                                   class="bg-black bg-opacity-10 h-6 w-60 p-4 pr-12" th:value="${kw}"/>
                            <a id="btn_search"
                               class="absolute right-0 top-0 bottom-0 flex items-center justify-center text-black text-lg pr-3">
                                <i class="search-Button fas fa-search text-gray-700"></i>
                            </a>
                        </div>
                        <a href="/library/soundupload"
                           class="bg-black bg-opacity-10 h-6 p-4 w-26 ml-4 text-sm flex items-center justify-center hover:bg-opacity-30">
                            <span class="text-center">음원 등록</span>
                        </a>
                    </div>

                    <!-- 음악 목록 -->
                    <div class="overflow-x-auto mt-2 mx-auto">
                        <div style="width: 900px; margin: 0 auto;">
                            <table class="table w-full">
                                <!-- head -->
                                <thead>
                                <tr class="text-center text-[#1f2937]">
                                    <th>번호</th>
                                    <th>앨범 커버</th>
                                    <th>음악 제목</th>
                                    <th>아티스트</th>
                                    <th>좋아요</th>
                                </tr>
                                </thead>
                                <tbody class="cursor-pointer">
                                <tr class="hover" th:each="fileInfo, loop : ${paging}">
                                    <td th:text="${paging.getTotalElements - (paging.number * paging.size) - loop.index}"></td>
                                    <td>
                                        <div class="image-container">
                                            <img th:src="${fileInfo.getAlbumCoverUrl()}" alt="" class="w-16 h-16 object-cover">
                                            <a class="play-button flex items-center justify-center p-3 hover:text-gray-300 mr-4"
                                               th:onclick="playMusic(/*[[${fileInfo.getSoundUrl}]]*/ null,
                                               /*[[${fileInfo.title}]]*/ null, /*[[${fileInfo.artist.username}]]*/ null, this)">
                                                <i class="fas fa-play text-5xl"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        <a id="subject" th:href="@{|/library/soundDetail/${fileInfo.id}|}"
                                           th:text="${fileInfo.title}"
                                           class="whitespace-nowrap overflow-x-hidden overflow-ellipsis"></a>
                                    </td>
                                    <td>
                                        <button id="author" th:text="${fileInfo.artist.username}"></button>
                                    </td>
                                    <td>
                                        <a href="#">
                                            <i class="far fa-heart text-gray-600"></i>
                                            131
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                            <!-- 페이징처리 시작 -->
                            <div th:if="${!paging.isEmpty()}" class="flex justify-center mt-2">
                                <div class="btn-group pagination">
                                    <a class="page-link btn btn-xs" th:disabled="${!paging.hasPrevious} ? 'disabled'"
                                       href="javascript:void(0)" th:data-page="${(paging.number)-1}">
                                        <span>이전</span>
                                    </a>
                                    <a th:text="${page}" class="page-link btn btn-xs"
                                       th:each="page: ${#numbers.sequence(0, (paging.totalPages)-1)}"
                                       th:if="${page >= (paging.number)-5 and page <= paging.number+5}"
                                       href="javascript:void(0)"
                                       th:data-page="${page}"></a>
                                    <a class="page-link btn btn-xs" th:disabled="${!paging.hasNext} ? 'disabled'"
                                       href="javascript:void(0)" th:data-page="${paging.number+1}">
                                        <span>다음</span>
                                    </a>
                                </div>
                            </div>
                            <!-- 페이징처리 끝 -->

                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="player-bar flex items-center w-full border-2 bg-gray-300 h-16">
        <div class="flex mx-auto gap-14 items-center">
            <div class="gap-5 flex w-40 justify-center">
                <button class="flex items-center justify-center p-3 hover:text-white" onclick="playPrevious()">
                    <i class="fa-solid fa-backward-step"></i>
                </button>
                <!-- 재생/일시정지 버튼 -->
                <button id="playPauseButton" class="flex items-center justify-center w-14 p-3 hover:text-white">
                    <i class="fas fa-play"></i>
                </button>
                <!-- 다음곡 버튼 -->
                <button class="flex items-center justify-center p-3 hover:text-white" onclick="playNext()">
                    <i class="fa-solid fa-forward-step"></i>
                </button>
            </div>
            <div class="flex gap-3 items-center">
                <span id="currentTime" class="text-sm w-10">0:00</span>
                <input id="songSlider" type="range" value="0" class="slider" style="flex-grow: 3;">
                <span id="totalTime" class="text-sm w-10">0:00</span>
            </div>
            <div class="flex items-center">
                <img src="https://cdn.jsdelivr.net/gh/LeeYulhee/projectlion_img/album/IU-album.jpg" alt="" class="w-10 h-10 object-cover mr-3">
                <div class="flex flex-col w-56">
                    <span id="st_title" class="text-xs" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap">제목</span>
                    <span id="st_artist" class="text-xs" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap">아티스트</span>
                </div>
            </div>
        </div>
    </div>

    <form th:action="@{|/library/list|}" method="get" id="searchForm">
        <input type="hidden" id="kw" name="kw" th:value="${kw}">
        <input type="hidden" id="page" name="page" th:value="${paging.number}">
    </form>

    <!-- 오디오 올린 음원-->
    <audio id="audio" style="display:none;">
        <source src="https://cdn.jsdelivr.net/gh/LeeYulhee/projectlion_img/album/Spring On by jurunde .mp3" type="audio/mpeg">
    </audio>

    <script th:inline="javascript">
        const page_elements = document.getElementsByClassName("page-link");
        Array.from(page_elements).forEach(function (element) {
            element.addEventListener('click', function () {
                document.getElementById('page').value = this.dataset.page;
                document.getElementById('searchForm').submit();
            });
        });

        const btn_search = document.getElementById("btn_search");
        btn_search.addEventListener('click', function () {
            document.getElementById('kw').value = document.getElementById('search_kw').value;
            document.getElementById('page').value = 0;  // 검색버튼을 클릭할 경우 0페이지부터 조회한다.
            document.getElementById('searchForm').submit();
        });

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URL(location.href).searchParams;
            let currentPage = parseInt(urlParams.get('page'));
            const pageButtons = document.getElementsByClassName("page-link");

            for (let i = 0; i < pageButtons.length; i++) {
                const pageButton = pageButtons[i];
                const pageNumber = parseInt(pageButton.dataset.page);
                if (isNaN(currentPage)) {
                    currentPage = 0;
                }
                if (pageNumber === currentPage) {           // 지금 현재 페이지
                    pageButton.classList.remove("btn-outline")
                    pageButton.classList.add("btn-neutral");
                } else {
                    pageButton.classList.add("btn-outline")
                    pageButton.classList.remove("btn-neutral");
                }
            }
        });
    </script>

    <script>
        let currentButton = null; // 전역 변수로 버튼을 저장할 변수를 선언합니다.

        // 타임바 업데이트 함수
        const audio = document.getElementById('audio');
        const playPauseButton = document.getElementById('playPauseButton');
        const songSlider = document.getElementById('songSlider');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');

        // Set initial max value for slider (it can be any value greater than 0)
        songSlider.max = 1;
        audio.addEventListener('loadedmetadata', function() {
            totalTime.textContent = formatTime(audio.duration);
            songSlider.max = audio.duration;
        });

        audio.addEventListener('timeupdate', function() {
            currentTime.textContent = formatTime(audio.currentTime);
            songSlider.value = audio.currentTime;
            const progress = (audio.currentTime / audio.duration) * 100;
            songSlider.style.background = `linear-gradient(to right, black ${progress}%, #d3d3d3 ${progress}%)`;
        });

        songSlider.addEventListener('input', function() {
            audio.currentTime = songSlider.value;
        });

        playPauseButton.addEventListener('click', function() {
            if (audio.paused) {
                audio.play();
                playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
                currentButton.innerHTML = '<i class="fas fa-pause text-5xl"></i>';
            } else {
                audio.pause();
                playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
                currentButton.innerHTML = '<i class="fas fa-play text-5xl"></i>';
            }
        });

        audio.addEventListener('ended', function() {
            playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
            currentButton.innerHTML = '<i class="fas fa-play text-5xl"></i>';
        });

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${    seconds < 10 ? '0' : ''
            }${seconds}`;
        }

        function playPrevious() {
            // 이전곡 재생 기능을 구현하세요.
        }

        function playNext() {
            // 다음곡 재생 기능을 구현하세요.
        }

        function playMusic(soundUrl, title, artist, button) {
            const st_title = document.getElementById('st_title');
            const st_artist = document.getElementById('st_artist');

            if (soundUrl && audio.src !== soundUrl) {
                audio.src = soundUrl; // 소스 경로 수정
            }

            st_title.textContent = title;
            st_artist.textContent = artist;

            if (currentButton !== null && currentButton !== button) {
                // 이전 버튼이 존재하고 현재 버튼과 다른 경우
                currentButton.innerHTML = '<i class="fas fa-play text-5xl"></i>'; // 이전 버튼을 일시정지 아이콘으로 변경
            }

            if (audio.paused) {
                audio.play();
                button.innerHTML = '<i class="fas fa-pause text-5xl"></i>';
                playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audio.pause();
                button.innerHTML = '<i class="fas fa-play text-5xl"></i>';
                playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
            }

            currentButton = button; // 현재 버튼을 전역 변수에 저장합니다.
        }
    </script>
</main>
</body>
</html>